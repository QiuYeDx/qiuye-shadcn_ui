---
alwaysApply: true
name: qiuye-ui-component-authoring
description: 用于 QiuYe UI（基于 shadcn/ui + Next.js App Router）的自定义组件新增、修改、注册、展示与 Registry 集成的完整编码与发布规范。
---

## 你是谁（Cursor Agent 行为准则）

你是本仓库（自定义 shadcn/ui 组件库 + Next.js 展示站点）的编码代理。你的输出和代码修改必须以**不遗漏步骤**、**可复现**、**与现有结构保持一致**为第一优先级。

- 语言：所有解释/注释优先使用**中文（简体）**。
- 技术栈：Next.js App Router（`app/`）、React 19、TypeScript、Tailwind CSS、shadcn/ui（`components/ui`）、自定义组件（`components/qiuye-ui`）。
- 包管理：仓库内以 **pnpm** 为准（除非用户明确要求 npm/yarn）。

---

## 项目关键结构（必须理解）

- **基础组件（shadcn/ui）**：`components/ui/*`  
  - 由 shadcn CLI 生成/维护，尽量不要在没有明确需求时大改其 API。
- **自定义组件库（QiuYe UI）**：`components/qiuye-ui/*`  
  - 每个自定义组件一个文件（kebab-case）。
  - 对应的演示组件：`components/qiuye-ui/demos/*-demo.tsx`
- **站点：组件列表与详情页**：
  - 列表页：`app/components/page.tsx`（数据来自 `lib/registry.ts`）
  - 详情页：`app/components/[id]/page.tsx`（需要把 demo 映射进来）
  - 详情页快速预览 demo：`app/components/[id]/simple-demos.tsx`（手动维护）
- **站点：CLI 文档页**：`app/cli/page.tsx`（含“可用组件列表”，当前是手动数组）
- **站点侧注册表（用于展示/检索）**：
  - 组件 ID/基础用法：`lib/component-constants.ts`
  - 组件元信息注册表：`lib/registry.ts`
- **shadcn Registry（给 shadcn CLI 安装用）**：
- `public/registry/<name>.json`：单组件 registry item（包含源码 content）
- `public/registry/registry.json`：registry 清单（由脚本生成，避免手改）
- 更新脚本：`scripts/update-registry.mjs`（仓库脚本：`pnpm update-registry`）
- **shadcn CLI Registry 配置**：`components.json`
  - 本地开发默认：`"@qiuye-ui": "http://localhost:3000/registry/{name}.json"`

---

## 最重要：给本组件库新增「自定义组件」的完整流程（不得遗漏）

> 目标：新增一个可在站点展示、可在 `/registry/<name>.json` 访问、可被 `shadcn add @qiuye-ui/<name>` 安装的组件。

### 0）命名与范围确认（必须做）

- **组件 ID**：使用 **kebab-case**，例如 `fancy-card`  
- **组件导出名**：使用 **PascalCase**，例如 `FancyCard`
- **决定是否是 Client Component**：
  - 只要用到 hooks、事件处理、`motion/react` 动画、`useState/useEffect` 等，就必须在组件文件顶部加 `"use client";`
- **列清依赖**
  - **dependencies（npm 包）**：例如 `motion`、`lucide-react`、`class-variance-authority`
  - **registryDependencies（shadcn 组件名）**：例如 `tabs`、`badge`、`dialog`（这些是 shadcn CLI 能识别/拉取的依赖组件）

### 1）实现组件源码（必须）

- 新增文件：`components/qiuye-ui/<id>.tsx`
- 规范要求：
  - 用 `@/lib/utils` 的 `cn` 合并 className
  - 需要 ref 的组件优先用 `React.forwardRef`
  - 导出保持与现有组件一致（`export { Xxx }`，必要时导出 variants）
  - 组件 API（props）要明确：类型、默认值、可选/必选
  - **必须按照「JSDoc / 注释规范」为 interface、props、组件函数编写完整 JSDoc**（详见下方独立章节）

### 2）实现 Demo（必须）

- 新增文件：`components/qiuye-ui/demos/<id>-demo.tsx`
- Demo 要求：
  - 覆盖核心能力/典型场景
  - 作为站点详情页 “演示” Tab 的主要内容

### 3）补齐站点侧注册信息（必须）

#### 3.1 更新组件 ID 枚举与基础用法

编辑 `lib/component-constants.ts`：

- 在 `ComponentId` enum 中新增 `NEW_COMPONENT = "<id>"`  
- 在 `basicUsageExamples` 中新增对应项：
  - `import`：必须使用 `@/components/qiuye-ui/<id>` 路径
  - `usage`：给出最小可运行用法（可包含必要的 state 示例）

#### 3.2 更新组件元信息注册表

编辑 `lib/registry.ts`：

- 在 `componentRegistry` 新增条目（key 使用 `ComponentId.<NEW>`）：
  - `name / description / category / tags`
  - `dependencies`（npm 包名数组）
  - `files.component = "components/qiuye-ui/<id>.tsx"`
  - `files.demo = "components/qiuye-ui/demos/<id>-demo.tsx"`
  - `props`（单组件）或 `propsInfo`（多子组件导出时使用）
  - `cliName = "<id>"`
  - `basicUsage = basicUsageExamples[ComponentId.<NEW>]`

### 4）把 Demo 接入详情页（必须，否则详情页会显示“演示组件正在开发中...”）

编辑 `app/components/[id]/page.tsx`：

- `import { XxxDemo } from "@/components/qiuye-ui/demos/<id>-demo";`
- 在 `demoComponents` 对象里新增映射：`[ComponentId.<NEW>]: XxxDemo`

同时编辑 `app/components/[id]/simple-demos.tsx`（用于“快速预览”）：

- 新增 `XxxSimpleDemo()` 组件（尽量简单、无复杂交互）
- 在 `app/components/[id]/page.tsx` 的 `simpleDemoComponents` 中新增映射

### 5）补齐 CLI 文档页（建议做，避免文档漏列）

编辑 `app/cli/page.tsx`：

- 在 “可用组件列表” 的数组中加入新 `ComponentId.<NEW>`
  - （当前是手动维护；若你顺手能改成从 `COMPONENT_IDS` 动态生成也可以，但要确保 UI/动画逻辑不被破坏）

### 6）新增 registry item JSON（必须，给 shadcn CLI 用）

新增文件：`public/registry/<id>.json`（可先不写 content，让脚本生成）

最低要求字段（与现有文件保持一致）：

- `"$schema": "https://ui.shadcn.com/schema/registry-item.json"`
- `"name": "<id>"`
- `"title": "<PascalCaseName>"`
- `"type": "registry:component"`
- `"author": "QiuYeDx <me@qiuyedx.com>"`（或保持当前作者格式）
- `"dependencies": [...]`（npm 包）
- `"registryDependencies": [...]`（shadcn 组件名）
- `"files": [{ "type": "registry:component", "path": "components/qiuye-ui/<id>.tsx" }]`

注意：

- 不要手动维护 `files[].content`（容易过期），后续用脚本自动写入。
- `public/registry/registry.json` **不要手改**，由脚本生成。
- 如果组件需要**拆分多个文件**（例如 `types.ts` / `utils.ts` / 多个导出文件），必须把这些文件都加入 `files[]`，否则用户通过 shadcn CLI 安装后会缺文件。
  - 为了让 `pnpm update-registry` 能自动写入源码内容，建议这些条目的 `type` 也使用 `registry:component`。

### 7）更新 registry 内容与清单（必须）

在仓库根目录执行：

- `pnpm update-registry`

该命令会：

- 把 `public/registry/*.json` 中 `files[].content` 更新为 `components/qiuye-ui/*` 的真实源码
- 重新生成 `public/registry/registry.json`

### 8）本地验证（必须做完再结束）

- **站点验证**：
  - `pnpm dev` 后打开：
    - `/components`：列表中能看到新组件（分类/搜索正常）
    - `/components/<id>`：详情页能渲染 demo、快速预览、API 表格、依赖区块
- **Registry 验证**（用于 shadcn CLI）：
  - 访问：`http://localhost:3000/registry/<id>.json`
  - 确认 JSON 中 `files[0].content` 与源码一致、依赖字段完整
- **可选：CLI 安装验证（需要本地 dev server 正在运行）**：
  - 在任意测试项目里：`pnpm dlx shadcn@latest add @qiuye-ui/<id>`

---

## 同样重要：修改「现有组件」时的必要流程（不得遗漏）

> 目标：确保修改后的组件源码、Registry JSON、站点元信息保持一致，用户通过 `shadcn add @qiuye-ui/<name>` 安装时能获得完整、最新的文件与依赖。

对现有组件做任何修改后，必须**逐条对照以下检查清单**，判断哪些步骤需要重新执行。

### 1）判断变更类型，决定需要同步的范围

| 变更类型 | 需要同步的内容 |
|---|---|
| **仅修改组件源码**（逻辑/样式/JSDoc） | → 执行 `pnpm update-registry`（同步 `files[].content`） |
| **新增/移除了组件引用的本地文件**（如 hook、utils、类型文件） | → 更新 `public/registry/<id>.json` 的 `files[]`，再执行 `pnpm update-registry` |
| **新增/移除了 npm 依赖** | → 更新 `public/registry/<id>.json` 的 `dependencies` / `registryDependencies`，同步更新 `lib/registry.ts` 的 `dependencies` |
| **Props 接口变更**（新增/删除/重命名 prop，默认值变化） | → 更新 `lib/registry.ts` 的 `props` / `propsInfo` 字段 |
| **基础用法变更**（导出名变化、最小示例需要调整） | → 更新 `lib/component-constants.ts` 的 `basicUsageExamples` |
| **组件分类/描述/标签变更** | → 更新 `lib/registry.ts` 的 `name` / `description` / `category` / `tags` |
| **Demo 逻辑需要跟随变更** | → 更新 `components/qiuye-ui/demos/<id>-demo.tsx` 和/或 `app/components/[id]/simple-demos.tsx` |

### 2）重点场景：组件引入了新的本地文件

当组件新增了对项目内其他文件的引用（最常见的是通用 hook 或工具函数），**必须**将这些文件加入 `public/registry/<id>.json` 的 `files[]`，否则用户通过 shadcn CLI 安装后会**缺少依赖文件**导致编译失败。

#### 判断依据

检查组件源码中所有 `import ... from "@/..."` 的导入路径：

- 来自 `@/components/ui/*` 的导入 → 由 `registryDependencies` 管理（shadcn 会自动拉取），**不需要**加入 `files[]`
- 来自 `@/lib/utils` 的导入 → 属于 shadcn 基础设施，**不需要**加入 `files[]`
- 来自 `@/hooks/*`、`@/lib/*`（非 utils）、`@/components/qiuye-ui/*`（其他子文件）等的导入 → **必须**加入 `files[]`

#### 操作步骤

以组件 `image-viewer` 引入了 `hooks/use-hover-support.ts` 和 `hooks/use-prevent-scroll.ts` 为例：

1. **编辑 `public/registry/<id>.json`**，在 `files[]` 数组中追加新条目：

   ```json
   {
     "files": [
       { "type": "registry:component", "path": "components/qiuye-ui/image-viewer.tsx" },
       { "type": "registry:hook", "path": "hooks/use-hover-support.ts" },
       { "type": "registry:hook", "path": "hooks/use-prevent-scroll.ts" }
     ]
   }
   ```

   - `type` 建议根据文件类型选用：`registry:hook`（hook）、`registry:lib`（工具函数/类型）、`registry:component`（子组件文件）
   - 为了让 `pnpm update-registry` 能自动写入 `content`，确保 `path` 指向仓库内实际文件
2. **执行 `pnpm update-registry`**：脚本会自动读取每个 `files[].path` 对应的源码并写入 `content` 字段

#### 常见需要加入 `files[]` 的文件类型

- `hooks/use-xxx.ts`：自定义 hooks
- `lib/xxx.ts`（非 `utils.ts`）：工具函数、常量、类型定义
- `components/qiuye-ui/<id>/*.ts(x)`：组件拆分出的子文件（如类型、变体、子组件）

### 3）重点场景：新增或移除了 npm / shadcn 依赖

- **新增 npm 依赖**：
  1. `pnpm add <pkg>`
  2. 在 `public/registry/<id>.json` 的 `"dependencies"` 数组中加入包名
  3. 在 `lib/registry.ts` 对应条目的 `dependencies` 数组中加入包名
- **新增 shadcn 组件依赖**（如组件内新 import 了 `@/components/ui/badge`）：
  1. 在 `public/registry/<id>.json` 的 `"registryDependencies"` 数组中加入 shadcn 组件名（如 `"badge"`）
- **移除依赖**：反向操作，从上述位置删除对应条目

### 4）修改后必须执行 `pnpm update-registry`

**任何**对以下内容的修改都需要重新执行此命令：

- `components/qiuye-ui/<id>.tsx`（组件源码）
- `hooks/*`、`lib/*` 等被 `files[]` 引用的文件
- `public/registry/<id>.json`（修改了 `files[]`、`dependencies` 等字段）

该命令会：

- 将所有 `public/registry/*.json` 中 `files[].content` 更新为对应源文件的最新内容
- 重新生成 `public/registry/registry.json` 清单

### 5）修改后验证

- **Registry 验证**：访问 `http://localhost:3000/registry/<id>.json`，确认：
  - `files[].content` 与最新源码一致
  - `dependencies` / `registryDependencies` 完整、无多余项
  - 所有被组件 import 的本地文件都已出现在 `files[]` 中
- **站点验证**（如果修改了 props / demo / 元信息）：
  - `/components/<id>` 详情页正常渲染，API 表格与实际 props 一致
- **可选：CLI 安装验证**：
  - `pnpm dlx shadcn@latest add @qiuye-ui/<id>`，确认安装后项目能正常编译

---

## 修改约束（避免破坏现有行为）

- 不要随意改变已有组件导出名/文件名（这会破坏 registry/文档/安装路径）。
- `public/registry/registry.json` 不手工编辑；通过 `pnpm update-registry` 生成。
- 新增依赖时：
  - 用 `pnpm add <pkg>`（或 `pnpm add -D <pkg>`）
  - **必须**同步更新 `public/registry/<id>.json` 的 `"dependencies"` / `"registryDependencies"`（这是 shadcn CLI 安装时依赖解析的依据）
  - `lib/registry.ts` 的 `dependencies` 用于站点展示/复制安装命令：可精简，但不要漏掉用户实际需要的关键三方依赖（例如 `motion`、`lucide-react`、`class-variance-authority` 等）

---

## JSDoc / 注释规范（编写与修改组件时必须遵守）

> 目标：确保在编辑器中**悬浮组件名或 prop 名时**，能看到清晰的中文说明、默认值与用法示例。

### 1. Props Interface

- **每个导出的 interface / type** 必须有一行简要 JSDoc 描述：

  ```ts
  /** ImageViewer 组件的属性 */
  interface ImageViewerProps { ... }
  ```

- **每个 prop** 必须有 JSDoc 注释，说明含义、取值范围、注意事项：

  ```ts
  /**
   * 灯箱遮罩层是否启用背景模糊效果
   * @default false
   */
  overlayBlur?: boolean;
  ```

- 有默认值的 prop **必须**使用 `@default` 标签标注实际默认值。
- 支持多种取值形式的 prop（如 `number | string`），应在注释中说明每种形式的含义：

  ```ts
  /**
   * 非灯箱模式下图片的最大高度
   * - 传入 `number` 时单位为 px
   * - 传入 `string` 时作为 CSS 值（如 `"50vh"`）
   */
  maxHeight?: number | string;
  ```

### 2. 组件函数

- **每个导出的组件函数** 必须有组件级 JSDoc，包含：
  1. **组件名 + 一句话概述**（如 `ImageViewer — 图片查看器组件`）
  2. **核心功能列表**（用 `-` 列出 3–6 条关键能力）
  3. **`@example` 用法示例**（至少覆盖基本用法，推荐 2–3 个典型场景）

  ```ts
  /**
   * ImageViewer — 图片查看器组件
   *
   * 提供带灯箱（Lightbox）预览的图片展示，支持：
   * - 点击缩略图打开全屏灯箱，带 layoutId 过渡动画
   * - 灯箱内双指捏合缩放 / 鼠标滚轮缩放
   * - 图片加载骨架屏、加载失败占位符
   *
   * @example
   * ```tsx
   * <ImageViewer src="/photo.jpg" alt="示例" />
   * ```
   */
  export function ImageViewer({ ... }: ImageViewerProps) { ... }
  ```

### 3. 辅助类型与内部类型

- **导出的辅助类型**（如 `TabItem`、`ToggleEffectPreset`）也需要 JSDoc。
- 非导出的内部类型（如私有 helper type）可选，但建议对含义不直观的类型加注释。

### 4. 子组件

- 同一文件中导出多个子组件（如 `ScrollableDialogHeader`、`ScrollableDialogContent`、`ScrollableDialogFooter`）时，每个子组件函数都需要单独的 JSDoc，说明其在组合中的角色与定位行为。

### 5. 注释语言

- 所有 JSDoc 内容统一使用**中文（简体）**，与项目整体保持一致。
- `@example` 中的代码可以使用英文命名（组件名、prop 名本身就是英文）。

### 6. 注意事项

- **仅补充注释，不修改代码逻辑**：完善 JSDoc 时严禁改动实际运行代码。
- 避免在注释中重复 TypeScript 已表达的信息（如不需要写"类型为 boolean"，TS 已有类型标注）。
- `@default` 的值应与代码中解构默认值一致，如有出入以代码为准并更新注释。

---

## 可选：发布/工具链补齐（做库发布时建议同步）

- 如果你要发布/更新 MCP Server（`packages/qiuye-ui-cli`）并希望在远端缺少 `registry.json` 时也能列出新组件：
  - 更新 `packages/qiuye-ui-cli/bin/qiuye-ui-mcp.mjs` 里的 `DEFAULT_COMPONENT_NAMES`（兜底列表）

---

## 提交前自检（如果你做了较大改动）

- `pnpm lint`
- 关键页面能打开且无运行时报错：`/components`、`/components/<id>`、`/cli`
